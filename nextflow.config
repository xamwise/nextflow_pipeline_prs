/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

// Nextflow configuration

// Pipeline parameters
params {
    // Input/Output
    input_plink = "./data/qc"
    outdir = "./out"
    
    // Data splitting
    test_size = 0.2
    val_size = 0.1
    n_folds = 5
    seed = 42
    
    // Training
    max_epochs = 100
    batch_size = 32
    learning_rate = 0.001
    
    // Hyperparameter optimization
    n_trials = 20
    
    // Logging
    wandb_project = "prs-prediction"
    wandb_entity = null
    
    // Resources
    max_memory = '32.GB'
    max_cpus = 8
    max_time = '48.h'


    // ----------------- General parameters for PRS models and QC -----------------
    population = "EUR"
    base_dir = System.getProperty("user.dir")
    bin_dir = "${projectDir}/bin"
    
    // Pipeline control flags
    run_qc = true
    run_prs = true
    run_dl = false
    use_existing_qc = false
    
    // PRS model selection
    run_lassosum = true
    run_prsice = true
    run_ldpred2 = true
    run_prs_cs = true
    
    // QC parameters
    qc {
        maf = 0.01
        mind = 0.01
        geno = 0.01
        hwe = 1e-6
    }
    
    // Summary statistics QC
    qc_sum {
        info = 0.8
        maf = 0.01
    }
    
    // Relatedness threshold
    relatedness {
        cutoff = 0.125
    }
    
    // PCA settings
    pcs {
        pca = 6
    }
    
    // PRSice parameters
    prsice {
        a1 = "A1"
        a2 = "A2"
        stat = "OR"
        binary_target = "F"
        base_maf = "MAF:0.01"
        base_info = "INFO:0.8"
    }
    
    // LDpred2 parameters
    ldpred2 {
        trait = "quant"
        model = "inf"
    }
    
    // PRS-CS parameters
    prs_cs {
        n_gwas = 20000
    }
    
    // Output directories (relative to base_dir)
    output_dir = "data/results"
    qc_dir = "data/qc"
}

// Process configuration
process {
    // Default resources
    cpus = 2
    memory = '8.GB'
    time = '2.h'
    
    // Specific process resources
    withName: CONVERT_PLINK {
        cpus = 4
        memory = '16.GB'
    }
    
    withName: HYPERPARAMETER_OPTIMIZATION {
        cpus = 8
        memory = '16.GB'
        time = '24.h'
    }
    
    withName: TRAIN_KFOLD {
        cpus = 4
        memory = '16.GB'
        time = '12.h'
        accelerator = 1  // GPU if available
    }
    
    withName: EVALUATE_MODELS {
        cpus = 4
        memory = '16.GB'
    }
}

// Profiles
profiles {
    standard {
        process.executor = 'local'
    }
    
    gpu {
        process.executor = 'local'
        process.containerOptions = '--gpus all'
        docker.enabled = true
        docker.runOptions = '--gpus all'
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'gpu'
        process.clusterOptions = '--gres=gpu:1'
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}

// Execution
executor {
    queueSize = 10
    pollInterval = '10 sec'
}

// Reports
// report {
//     enabled = true
//     file = "${params.outdir}/pipeline_report.html"
// }
// 
// timeline {
//     enabled = true
//     file = "${params.outdir}/timeline.html"
// }
// 
// trace {
//     enabled = true
//     file = "${params.outdir}/trace.txt"
// }
// 
// dag {
//     enabled = true
//     file = "${params.outdir}/pipeline_dag.pdf"
// }
